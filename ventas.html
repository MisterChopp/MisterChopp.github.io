<!DOCTYPE html>
<html class="no-js">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mister Chopp - Reservas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="favicon.ico">
    <link href="images/icon.png" rel="icon">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    
    <!-- Bootstrap and Style CSS -->
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        .text-success {
            color: #FFA500 !important; 
        }

        .text-warning {
            color: #FFA500 !important; 
        }
  
        h2, h3 {
            font-family: 'Arial', sans-serif;
            font-weight: bold;
        }
        h2 {
            color: #000000;
            margin-bottom: 20px;
        }
        h3 {
            margin-bottom: 15px;
        }
        .form-group label {
            font-weight: bold;
        }
        .btn-success {
            background-color: #FFA500;
            color: white;
            border: none;
        }
        .btn-success:hover {
            background-color: #FFA500;
        }
        .btn-lg {
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
        }
        #receipt p {
            margin: 10px 0;
            font-size: 16px;
        }
        #receipt strong {
            color: #FFA500;
        }
        .rounded {
            border-radius: 8px;
        }

    </style>
</head>
<body>
    <div id="fh5co-page">
        <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
        <aside id="fh5co-aside" role="complementary" class="border js-fullheight">
            <h1>
                <a href="index.html">
                    <img src="images/apple-touch-icon.png" alt="Logo Mister Chopp" style="width: 100%; height: auto;">
                </a>
            </h1>
            <nav id="fh5co-main-menu" role="navigation">
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li class="fh5co-active"><a href="ventas.html">Registrar venta</a></li>
                    <li><a href="productos.html">Inventario</a></li>
                    <li><a href="dashboard.html">Reportes</a></li>
                    <li><a href="horarios.html">Horario - Empleados</a></li>
                    <li><a href="detalle_reservas.html">Reservas</a></li>
                    <li><a href="login.html">Cerrar Sesión</a></li>
                </ul>
            </nav>
        </aside>
    
        <div id="fh5co-main">
            <div id="content-section" class="fh5co-narrow-content animate-box">
                <h2 class="text-center">Gestión de Ventas</h2>
                
                <div class="row">
                    <!-- Ventas -->
                    <div class="col-md-6">
                        <h2></h2>
                        <h3 class="text-success"><i class="fas fa-cash-register"></i> Registrar Venta</h3>
                        <form id="salesForm" class="bg-light p-4 rounded shadow-sm">
                            <div class="form-group">
                                <label for="employeeSelect">Empleado:</label>
                                <select id="employeeSelect" class="form-control">
                                    <option value="E01">Jordi Gonzalez</option>
                                    <option value="E02">Andy Fernandez</option>
                                    <option value="E03">Walter Lopez</option>
                                    <option value="E04">Wilfredo Sanchez</option>
                                    <option value="E05">Luis Gomez</option>
                                    <option value="E06">Omaar Diaz</option>
                                    <option value="E07">Max Martinez</option>
                                    <option value="E08">Ricardo Hernandez</option>
                                    <option value="E09">Rodrigo Yrigoyn</option>
                                </select>
                            </div>
                            <h3></h3>
                            <div class="form-group">
                                <label for="customerName">Cliente:</label>
                                <input type="text" id="customerName" class="form-control" placeholder="Nombre del cliente" required>
                            </div>
                            <div class="form-group">
                                <label>Tragos:</label>
                                <div id="drinkOptions" class="form-control" style="height: auto;">
                                    <div>
                                        <input type="checkbox" id="drinkCubaLibre" value="Cuba Libre - S/12">
                                        <label for="drinkCubaLibre">Cuba Libre - S/12</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="drinkChilcano" value="Chilcano de Pisco - S/15">
                                        <label for="drinkChilcano">Chilcano de Pisco - S/15</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="drinkPeruLibre" value="Perú Libre - S/14">
                                        <label for="drinkPeruLibre">Perú Libre - S/14</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="drinkPiscoSour" value="Pisco Sour - S/18">
                                        <label for="drinkPiscoSour">Pisco Sour - S/18</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="drinkScrewDriver" value="Screw Driver - S/16">
                                        <label for="drinkScrewDriver">Screw Driver - S/16</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="drinkTequilaSunrise" value="Tequila Sunrise - S/18">
                                        <label for="drinkTequilaSunrise">Tequila Sunrise - S/18</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="drinkPinaColada" value="Piña Colada - S/20">
                                        <label for="drinkPinaColada">Piña Colada - S/20</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="drinkOrgasmo" value="Orgasmo - S/22">
                                        <label for="drinkOrgasmo">Orgasmo - S/22</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group text-center">
                                <button type="button" class="btn btn-success btn-lg w-100" onclick="registerSale()">Registrar Venta</button>
                            </div>
                        </form>
                    </div>
    
                    <!-- Comprobante de Pago -->
                    <div class="col-md-6">
                        <h2></h2>                        
                        <h3 class="text-warning"><i class="fas fa-receipt"></i> Comprobante de Pago</h3>
                        
                        <div id="receipt">
                            <p><strong>N° de Pedido:</strong> <span id="orderNumber"></span></p>
                            <p><strong>Empleado:</strong> <span id="receiptEmployee"></span></p>
                            <p><strong>Cliente:</strong> <span id="receiptCustomer"></span></p>
                            <p><strong>Bebidas y Precios:</strong> <span id="receiptDrink"></span></p>
                            <p><strong>Total:</strong> S/<span id="receiptPrice"></span></p>
                            <p><strong>Fecha:</strong> <span id="receiptDate"></span></p>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/jquery.flexslider-min.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    
    <script>
        let orderCounter = localStorage.getItem('orderCounter') ? parseInt(localStorage.getItem('orderCounter')) : 1;
        localStorage.setItem("inventory", JSON.stringify([
    { id: 'PR01', name: 'Sprite', stock: 50 },
    { id: 'PR02', name: 'Pisco Nacional Quebranta', stock: 20 },
    { id: 'PR03', name: 'Limón', stock: 100 },
    { id: 'PR04', name: 'Coca Cola', stock: 40 },
    { id: 'PR05', name: 'Clara de huevo', stock: 60 },
    { id: 'PR06', name: 'Agua', stock: 100 },
    { id: 'PR07', name: 'Jarabe de Goma', stock: 30 },
    { id: 'PR08', name: 'Amargo de Angostura', stock: 15 },
    { id: 'PR09', name: 'Jugo de Naranja', stock: 25 },
    { id: 'PR10', name: 'Jarabe de Granadina', stock: 20 },
    { id: 'PR11', name: 'Vodka', stock: 10 },
    { id: 'PR12', name: 'Tequila', stock: 12 },
    { id: 'PR13', name: 'Piña', stock: 30 },
    { id: 'PR14', name: 'Crema de Coco', stock: 15 },
    { id: 'PR15', name: 'Ron Blanco', stock: 10 },
    { id: 'PR16', name: 'Licor de Café', stock: 27 },
    { id: 'PR17', name: 'Bayleys', stock: 15 },
    { id: 'PR18', name: 'Amaretto', stock: 27 },
    { id: 'PR19', name: 'Leche', stock: 50 },
    { id: 'PR20', name: 'Ron', stock: 10 },
    { id: 'PR21', name: 'Cola', stock: 50 },
]));
        let inventory = JSON.parse(localStorage.getItem("inventory")) || [
            { id: 'PR01', name: 'Sprite', stock: 50 },
            { id: 'PR02', name: 'Pisco Nacional Quebranta', stock: 20 },
            { id: 'PR03', name: 'Limón', stock: 100 },
            { id: 'PR04', name: 'Coca Cola', stock: 40 },
            { id: 'PR05', name: 'Clara de huevo', stock: 60 },
            { id: 'PR06', name: 'Agua', stock: 100 },
            { id: 'PR07', name: 'Jarabe de Goma', stock: 30 },
            { id: 'PR08', name: 'Amargo de Angostura', stock: 15 },
            { id: 'PR09', name: 'Jugo de Naranja', stock: 25 },
            { id: 'PR10', name: 'Jarabe de Granadina', stock: 20 },
            { id: 'PR11', name: 'Vodka', stock: 10 },
            { id: 'PR12', name: 'Tequila', stock: 12 },
            { id: 'PR13', name: 'Piña', stock: 30 },
            { id: 'PR14', name: 'Crema de Coco', stock: 15 },
            { id: 'PR15', name: 'Ron Blanco', stock: 10 },
            { id: 'PR16', name: 'Licor de Café', stock: 27 },
            { id: 'PR17', name: 'Bayleys', stock: 15 },
            { id: 'PR18', name: 'Amaretto', stock: 27 },
            { id: 'PR19', name: 'Leche', stock: 50 },
            { id: 'PR20', name: 'Ron', stock: 10 },
            { id: 'PR21', name: 'Cola', stock: 50 },
        ];
        
        const drinkIngredients = {
            'Cuba Libre': ['PR20', 'PR04', 'PR03'],
            'Chilcano de Pisco': ['PR02', 'PR01', 'PR03'],
            'Perú Libre': ['PR02', 'PR04', 'PR03'],
            'Pisco Sour': ['PR02', 'PR05', 'PR03', 'PR06', 'PR07', 'PR08'],
            'Screw Driver': ['PR11', 'PR09', 'PR10'],
            'Tequila Sunrise': ['PR12', 'PR09', 'PR10'],
            'Piña Colada': ['PR15', 'PR13', 'PR14', 'PR06'],
            'Orgasmo': ['PR16', 'PR17', 'PR18', 'PR19'],
        };
        
        function updateInventory(drinkNames) {
            const updatedInventory = JSON.parse(localStorage.getItem("inventory"));
            let hasStock = true;
        
            drinkNames.forEach(drink => {
                const ingredients = drinkIngredients[drink];
                ingredients.forEach(productId => {
                    const product = updatedInventory.find(item => item.id === productId);
                    if (!product || product.stock <= 0) {
                        hasStock = false;
                        alert(`Producto agotado: ${product ? product.name : productId}`);
                    }
                });
            });
        
            if (hasStock) {
                drinkNames.forEach(drink => {
                    const ingredients = drinkIngredients[drink];
                    ingredients.forEach(productId => {
                        const product = updatedInventory.find(item => item.id === productId);
                        if (product) product.stock--;
                    });
                });
                localStorage.setItem("inventory", JSON.stringify(updatedInventory));
            } else {
                throw new Error("No hay suficiente stock para completar la venta.");
            }
        }
        
        function registerSale() {
    const employeeSelect = document.getElementById("employeeSelect");
    const customerName = document.getElementById("customerName").value;
    const drinkOptions = document.querySelectorAll("#drinkOptions input:checked");

    if (!customerName) {
        alert("Por favor, ingrese el nombre del cliente.");
        return;
    }

    if (drinkOptions.length === 0) {
        alert("Por favor, seleccione al menos un trago.");
        return;
    }

    const employee = employeeSelect.options[employeeSelect.selectedIndex].text;
    const date = new Date().toLocaleDateString();
    let sales = JSON.parse(localStorage.getItem("sales")) || [];

    try {
        const drinkNames = [];
        const drinkPrices = [];
        let total = 0;

        // Iterar sobre las opciones seleccionadas y extraer los datos
        drinkOptions.forEach(option => {
            const drinkInfo = option.value;
            const drinkName = drinkInfo.split(" -")[0];
            const price = parseFloat(drinkInfo.split("S/")[1]);

            // Guardar datos individuales
            drinkNames.push(drinkName);
            drinkPrices.push(price);
            total += price;
        });

        // Verificar si hay precios
        if (drinkPrices.length === 0) {
            throw new Error("No se encontraron precios para los tragos seleccionados.");
        }

        // Reducir inventario
        updateInventory(drinkNames);

        // Crear el objeto de venta
        const sale = {
            orderNumber: orderCounter,
            employee: employee,
            customer: customerName,
            drinks: drinkNames,
            price: drinkPrices, // Precios individuales
            total: total, // Suma total
            date: date,
        };

        sales.push(sale);

        // Guardar en localStorage
        localStorage.setItem("sales", JSON.stringify(sales));

        // Mostrar comprobante con precios detallados
        const receiptDetails = drinkNames.map((drink, index) => {
            const price = drinkPrices[index].toFixed(2);
            return `${drink} (S/${price})`;
        }).join(", ");

        document.getElementById("orderNumber").textContent = sale.orderNumber;
        document.getElementById("receiptEmployee").textContent = sale.employee;
        document.getElementById("receiptCustomer").textContent = sale.customer;
        document.getElementById("receiptDrink").textContent = receiptDetails;
        document.getElementById("receiptPrice").textContent = sale.total.toFixed(2);
        document.getElementById("receiptDate").textContent = sale.date;
        document.getElementById("receipt").style.display = "block";

        // Generar PDF
        generatePDF(sale);

        // Incrementar el número de pedido
        orderCounter++;
        localStorage.setItem("orderCounter", orderCounter.toString());
        alert("Venta registrada con éxito.");
    } catch (error) {
        alert(error.message);
    }
}

        
        async function generatePDF(sale) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const centerX = pageWidth / 2;
    const margin = 10;

    // URL de la imagen
    const imageUrl = 'https://media.discordapp.net/attachments/1017934104748101652/1310094122748481617/image.png?ex=6744a07b&is=67434efb&hm=f62b06da9d7a67aea2a6dbf31d9f5a73cb37dc41a1bc35aa1e7efe1fed98eb2e&=&format=webp&quality=lossless&width=1507&height=786';

    try {
        // Convertir la imagen a Base64
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        const reader = new FileReader();

        reader.onload = () => {
            const imgData = reader.result;

            // Añadir un encabezado con color de fondo
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor(255, 255, 255);
            doc.setFillColor(255, 165, 0);
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.text('Comprobante de Pago', centerX, 25, { align: 'center' });

            // Información del comprobante
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(`N° de Pedido: ${sale.orderNumber}`, 10, 50);
            doc.text(`Fecha: ${sale.date}`, 10, 60);
            doc.text(`Empleado: ${sale.employee}`, 10, 70);
            doc.text(`Cliente: ${sale.customer}`, 10, 80);

            doc.text(`Tragos:`, 10, 90);
            sale.drinks.forEach((drink, index) => {
                doc.text(`- ${drink}`, 15, 100 + index * 10);
            });

            // Total
            doc.setFontSize(16);
            doc.setTextColor(255, 0, 0);
            doc.text(`Total: S/${sale.total.toFixed(2)}`, 10, 150);

            // Dimensiones reducidas de la imagen
            const imgWidth = (pageWidth - 2 * margin) * 0.5; // 50% del ancho disponible
            const imgHeight = imgWidth * (520 / 825); // Mantener proporciones
            const imgX = (pageWidth - imgWidth) / 2; // Centrar horizontalmente
            const imgY = pageHeight - imgHeight - 40; // Espacio para el pie de página

            // Agregar la imagen centrada
            doc.addImage(imgData, 'PNG', imgX, imgY, imgWidth, imgHeight);

            // Pie de página
            doc.setFontSize(12);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(150, 150, 150);
            doc.text('Gracias por su compra en Mister Chopp', centerX, pageHeight - 10, { align: 'center' });

            // Guardar el PDF
            doc.save(`Comprobante_${sale.orderNumber}.pdf`);
        };

        reader.onerror = () => {
            console.error("Error al leer la imagen.");
        };

        reader.readAsDataURL(blob);
    } catch (error) {
        console.error("Error al cargar la imagen desde la URL:", error);
    }
}

        </script>
        
</body>
</html>
